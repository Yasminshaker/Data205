---
title: "illegal dumping activity"
author: "yasmin"
date: "2023-12-05"
output: html_document
---

```{r}
# Loading Packages and reading in Data

library(tidyverse)
library(tidygeocoder)
library(ggmap)
library(plotly)
library(mapview)
library(leaflet)
library(stats)


dmpact <- read_csv("https://data.montgomerycountymd.gov/api/views/d985-d2ak/rows.csv?accessType=DOWNLOAD")
```


```{r}
# Selecting necessary columns

dmpact1 <- dmpact %>% select(`Year case was opened`, `Case description`, `Case sub-type`, `Street number`, `Street Name`, City, Zip, Location)

colnames(dmpact1)[colnames(dmpact1) == "Year case was opened"] <- "Year"
colnames(dmpact1)[colnames(dmpact1) == "Case description"] <- "Description"
colnames(dmpact1)[colnames(dmpact1) == "Case sub-type"] <- "Type"

head(dmpact1)
```


```{r}
# Looking at the different cities 

sort(table(dmpact1$City))
```


```{r}
# fixing city columns 

recode_city <- function(data) {
  data %>%
    mutate(City = recode(City,
      "ASHTON" = "Ashton",
      "BARNESVILLE" = "Barnesville",
      "BEALLSVILLE" = "Beallsville",
      "BELTSVILLE" = "Beltsville",
      "BETHESDA" = "Bethesda",
      "BOYDS" = "Boyds",
      "BRINKLOW" = "Brinklow",
      "BROOKEVILLE" = "Brookeville", "Brookville" = "Brookeville",
      "BURTONSVILLE" = "Burtonsville",
      "CABIN JOHN" = "Cabin John",
      "CHEVY CHASE" = "Chevy Chase",
      "CLARKSBURG" = "Clarksburg",
      "DAMASCUS" = "Damascus",
      "DERWOOD" = "Derwood",
      "DICKERSON" = "Dickerson",
      "GAITHERSBURG" = "Gaithersburg", "Gaitherburg" = "Gaithersburg",
      "GARRETT PARK" = "Garrett Park",
      "GERMANTOWN" = "Germantown",
      "HIGHLAND" = "Highland",
      "KENSINGTON" = "Kensington",
      "LAUREL" = "Laurel",
      "MONTGOMERY VILLAGE" = "Montgomery Village",
      "MOUNT AIRY" = "Mount Airy",
      "Norht Potomac" = "North Potomac",
      "OLNEY" = "Olney",
      "POOLESVILLE" = "Poolesville",
      "POTOMAC" = "Potomac",
      "ROCKVILLE" = "Rockville", "rockville" = "Rockville",
      "SANDY SPRING" = "Sandy Spring",
      "SILVER SPRING" = "Silver Spring", "Silver Sprig" = "Silver Spring", "Silver spring" = "Silver Spring",
      "SPENCERVILLE" = "Spencerville",
      "TAKOMA PARK" = "Takoma Park", "Takoma park" = "Takoma Park",
      "WASHINGTON GROVE" = "Washington Grove"))}

dmpact1 <- dmpact1 %>% recode_city()
sort(table(dmpact1$City))
```


```{r}
# Bar graph to all the cities

v1 <- ggplot(data = dmpact1) + 
  geom_bar(aes(x = City))+ 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  labs(title = "Cities with the most cases", x = "City", y = "Number of Cases")

v1
```


```{r}
# Graphing the different types of waste

v2 <- ggplot(data = dmpact1) +
  geom_bar(mapping = aes(x = `Type`, fill = `Type`)) +
  ggtitle("Most Common Type of Waste" ) +
  ylab ("Number of Cases") +
  xlab("Types of Waste") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none")

v2
```


```{r}

yearcount <- as.data.frame(table(dmpact4$Year))

colnames(yearcount) <- c("Year", "Number_of_Cases")

ggplot(yearcount, aes(x = Year, y = Number_of_Cases)) +
  geom_point() + theme(axis.text.x = element_text(angle = 45)) + 
  labs(title = "Number of Cases Over Time",
       x = "Year",
       y = "Number of Cases")



```



```{r}
# Combining types of waste and top cities with the most activity

topcitites <- subset(dmpact1, City %in% c("Silver Spring", "Germantown", "Gaithersburg", "Rocville", "Bethesda", "Potomac"))

v3 <- ggplot(data = topcitites) + 
  geom_bar(aes(x = City, fill = Type), position = "dodge") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  labs(title = "Cities with the most cases", x = "City", y = "Number of Cases")


v3
```


```{r}
# Combining address columns to geocode missing latitude and longitude 

dmpact2 <- dmpact1 %>% mutate(county = "Montgomery County", state = "Maryland", Address = paste(`Street number`, `Street Name`, City, county, state, Zip, sep = ", ")) %>%
  mutate(Address = sub(", ", " ", Address), Address = gsub("NA", "", Address))

dmpact2 <- dplyr::select(dmpact2, -`Street number`, -`Street Name`, -Zip, -county, -state)

noloatlong <- dmpact2 %>%
  filter(is.na(Location))

register_google(key = '...')

dmpact3 <- noloatlong %>%
  mutate(geocoded_location = geocode(Address))


```


```{r}
# Fixing Long and Lat columns 

dmpact4 <- full_join(dmpact2, dmpact3)

dmpact4 <- dmpact4 %>% mutate(longitude = as.numeric(sub(".*\\((.*)\\s.*", "\\1", dmpact4$Location)), latitude = as.numeric(sub(".*\\s(.*)\\)", "\\1", dmpact4$Location))) %>% mutate(lat = paste(latitude, geocoded_location$lat), long = paste(longitude, geocoded_location$lon)) %>%
  mutate(lat = gsub("NA","", lat)) %>% mutate(long = gsub("NA","", long))

dmpact4 <- dplyr::select(dmpact4, -Address, -latitude, -longitude, -geocoded_location, -Location)

dmpact4$long <- as.numeric(dmpact4$long)
dmpact4$lat <- as.numeric(dmpact4$lat)

```


```{r}
# Mapping 

map <- ggplot(dmpact4, aes(x = long, y = lat)) 

map0 <- map + 
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    rect = element_blank()) +
  geom_point(aes(text=paste(paste("Year:", Year, "<br>"),   
                         paste("Type:", Type, "<br>"))))

map1 <- ggplotly(map0, tooltip = "text") 
print(map1)

```


```{r}
# Map 2
tooltip <- paste("Year: ", dmpact4$Year)
map1 < mapview(dmpact4, xcol = "long", ycol = "lat", crs = 4269, grid = F, zcol = "Type", col.regions = mapviewGetOption("raster.palette"), legend.opacity = 5, alpha = 1,  cex = 4, tooltip = tooltip)

map1

```


```{r}

map2 <- leaflet(dmpact4) %>%
  addTiles() %>%
  addCircleMarkers( lng = ~long, lat = ~lat, radius = 0.5, color = "black", popup = ~paste("Year: ", Year, "<br>Type: ", Type, "<br>City: ", City))

map2


```


```{r}
# Will there be over 300 cases next year?

yearcount$Year <- as.numeric(as.character(yearcount$Year))
threshold <- 300
yearcount$Above_Threshold <- ifelse(yearcount$Number_of_Cases > threshold, 1, 0)
logistic_model <- glm(Above_Threshold ~ Year, data = yearcount, family = "binomial")
new_data <- data.frame(Year = 2024)
predicted_prob <- predict(logistic_model, newdata = new_data, type = "response")
predicted_outcome <- ifelse(predicted_prob > 0.5, 1, 0)
cat("Predicted Probability:", predicted_prob, "\n")
cat("Predicted Outcome (Above 300 cases):", predicted_outcome, "\n")


```

